---
layout: post
comments: true
title: ! 'WP7 Panorama: Smoothly fading the background (and enabling fading when changing,
  too)'
wordpress_id: 718
wordpress_url: http://www.jeff.wilcox.name/2010/11/wp7-panorama-smooth-background-changing/
imported_categories:
- title: c#
  slug: csharp
  autoslug: c#
- title: silverlight
  slug: silverlight
  autoslug: silverlight
- title: windows-phone
  slug: windows-phone
  autoslug: windows-phone
imported_link_categories: []
tags: []
---
<p>I’ve heard a number of conversations with developers about wanting to smoothly fade in background image changes within the Panorama control that ships in the <a href="http://create.msdn.com/">Windows Phone 7 Developer Tools</a>.</p>  <p>I spent the better part of this rainy Seattle Sunday looking into this. I actually had a conversation with the famed <a href="http://kellabyte.com/">Kelly Sommers</a> (<a href="http://twitter.com/kellabyte">@kellabyte</a>) a few months ago about implementing a Panorama whose Background was automatically set to the daily Bing image, and was recently inspired by an internal developer discussion at Microsoft.</p>  <p>Here’s a video of the sample project where I was able to do just that, and more! The control takes care of smoothly fading any background property change, and the sample project grabs the daily Bing image to show in there as a sample, too.</p>  <p><object type="application/x-shockwave-flash" width="685" height="389" data="http://www.flickr.com/apps/video/stewart.swf?v=71377" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"> <param name="flashvars" value="intl_lang=en-us&amp;photo_secret=d96b9daf9e&amp;photo_id=5176150607&amp;hd_default=false"></param> <param name="movie" value="http://www.flickr.com/apps/video/stewart.swf?v=71377"></param> <param name="bgcolor" value="#000000"></param> <param name="allowFullScreen" value="true"></param><embed type="application/x-shockwave-flash" src="http://www.flickr.com/apps/video/stewart.swf?v=71377" bgcolor="#000000" allowfullscreen="true" flashvars="intl_lang=en-us&photo_secret=d96b9daf9e&photo_id=5176150607&hd_default=false" height="389" width="685"></embed></object></p>  <p>So if you just want to jump in, the source is all up in the sample project in <a href="http://az414997.vo.msecnd.net/wordpress/2010/11/DynamicPanoramaBackgrounds.zip">DynamicPanoramaBackgrounds.zip download (1.2 MB)</a>.</p>  <p>Feel free to use this in your own projects, it’s a simple set of extensions. This sort of effect is nice, but I’m personally glad that it isn’t built into the framework by default: there’s definitely some fixed performance cost to this sort of dynamic effect in the platform today.</p>  <p>I did a lot of testing on my phone and didn’t run into any noticeable performance issues, but beware that this implementation will increase the fill rate and have an effect over the standard, so don’t just use it without evaluating how important the scenario is to your apps. Note that this isn’t designed to do well when moving between background Brush types, or images of massively different sizes – but if they are all the same or similar, it should just work well!</p>  <h2>Using ‘DynamicBackgroundPanorama’</h2>  <p>Just set the Background property of the Panorama!</p>  <p>You can use data binding, or just straight code, for this. The example sample I wrote has two sub pages: one which just shows the current Bing search background for your region, and another which shows some photos that are just built into the project. No special work required!</p>  <p>I’ve packaged the control and its various components into the sample project instead of building out a standalone class library, so if you place it in your project, make sure you pick up all its individual files, including the Generic\Themes.xaml file that contains the default styles.</p>  <h3>Contrasting image note</h3>  <p>I haven’t addressed the contrasting image issue in this implementation. Ideally a second brush might be exposed, to allow for a translucent overlay of color such as a transparent black, over the backgrounds. This would help with keeping the contrast more appropriate, but I didn’t want to as it would increase the fill rate even more.</p>  <h2>Designing the primitive(s)</h2>  <p>It’s pretty straightforward to think about, but difficult to implement without also building out a few primitive controls to help with the re-templating experience.</p>  <p>So in designing the right implementation, I decided to mimic the same design ideas that went into the TransitioningContentControl (TCC) that is built into the <a href="http://silverlight.codeplex.com/">Silverlight Toolkit</a>’s layout control library. With that control, the Content property (or bound Content) is used in a cycle to smoothly animate out the old content and bring in the new content.</p>  <p>I wanted the same effect, but instead with just a Brush – in most situations an ImageBrush. I went ahead and started from the open source code to the TCC, changed the content presenters in the default style and control template to no longer be needed in the same way (I just derived from Control instead of ContentControl).</p>  <p>So here are the primitive components I built out:</p>  <h3>DynamicBackgroundPanorama</h3>  <p>A one-line control that derives from the official Panorama control. The constructor sets the DefaultStyleKey to the type, enabling the style from the Generic.xaml file to be pulled in automatically.</p>  <p>This is important because this scenario is built on re-templating and just a few primitive changes, and this type lets a developer use it without having to work very hard at all.</p>  <h3>UpdatingPanningLayer</h3>  <p>This is a one-method derived control, deriving from the primitive PanningBackgroundLayer. The purpose is to call the UpdateWrappingRectangles method, a protected method. This will cause the writeable bitmaps in the control to update so that the updated image changes will also update the “ears” or left/right wrapping rectangles used to show the wrap-around effect.</p>  <h3>TransitioningBackgroundControl</h3>  <p>Starting with the Silverlight Toolkit’s TransitioningContentControl created by <a href="http://www.sitechno.com/blog/">Mr. Ruurd Boeke</a>, I changed it up to instead work from the brushes. In case anyone is interested, changes from that were basically:</p>  <ul>   <li>Moving the ContentPresenter sites from typeof ContentPresenter to Grid </li>    <li>Updating the code to specific issues with image brushes, where I’d like to wait to kick off the transition until <em>after</em> the image actually loads. Most of this code is done in the StartTransition method, plus the addition of the Loading visual state. </li>    <li>I dropped a subset of the VisualStates internal class from the toolkit into the file, just to reduce the number of unique files needed for the solution. </li>    <li>Added a dependency property of type Brush and name DynamicBackground. I could have used just the standard Background property, but that actually takes more work to wire up to ‘change’ events than to just define a new property like this. </li>    <li>A special workaround in the OnApplyTemplate to walk up the visual tree and identify the UpdatingPanningLayer, if any. This lets me force the Panorama control to effectively bump and update the side images of the control used when you scroll beyond the edges of the extreme items. </li>    <li>Updating the template:      <ul>       <li>Removing the alternative defined transitions </li>        <li>Changing the default fade-in template by removing the fade out of the current – leads to a smoother look in my opinion </li>        <li>Adding a Loading visual state to help with the delay-load effect of loading an image brush from a URI, for smoothness. </li>        <li>Adding BitmapCache settings to the two individual sites (Grids) </li>     </ul>   </li> </ul>  <h3>Themes\Generic.xaml</h3>  <p>This file contains the custom template for Panorama as well as the important default style and template for the TransitioningBackgroundControl that I built. The differences from the official Panorama template are:</p>  <ul>   <li>The PanningLayer primitive is replaced by my UpdatingPanningLayer </li>    <li>The Border and background set in the content of the background panning layer has been replaced by my TransitioningBackgroundControl </li>    <li>The background has the margin offset to eliminate the seam </li>    <li>There is no BitmapCache setting on the background in Panorama, instead it is set within the transitioning control, for performance reasons. </li> </ul>  <p>I’ve also taken guidance from Panorama developer extraordinaire Dave Relyea’s posts:</p>  <ul>   <li><a href="http://blogs.msdn.com/b/devdave/archive/2010/09/17/panorama-tricks-how-to-eliminate-blending-seams.aspx">Eliminating seams</a> </li>    <li><a href="http://blogs.msdn.com/b/devdave/archive/2010/09/20/panorama-using-xaml-for-your-background.aspx">Using XAML for your Background</a> </li> </ul>  <p>Note that this project makes use of the Silverlight for Windows Phone Toolkit for transitions, so make sure you have it installed if you want to use the sample code.</p>  <h2>Download the sample project</h2>  <p><a href="http://az414997.vo.msecnd.net/wordpress/2010/11/DynamicPanoramaBackgrounds.zip">Sample Project and Control Implementation [ZIP]</a> (1.2 MB)     <br />Dependencies: Windows Phone developer tools and the <a href="http://silverlight.codeplex.com/">Silverlight for Windows Phone Toolkit</a> (for transitions in the example only. The control does not have this dependency)</p>  <p>Hope this helps!</p>
